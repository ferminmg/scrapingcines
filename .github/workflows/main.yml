name: Scraping Automatizado de Cines

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */4 * * *'     # Scraping general cada 4 horas
    - cron: '0 10,22 * * *'   # PrÃ³ximos estrenos a las 10:00 y 22:00 UTC
  workflow_dispatch:          # EjecuciÃ³n manual
    inputs:
      force_upcoming:
        description: 'Forzar ejecuciÃ³n de prÃ³ximos estrenos'
        required: false
        default: false
        type: boolean

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_run_upcoming: ${{ steps.check_schedule.outputs.should_run }}
    steps:
      - name: Verificar horario para prÃ³ximos estrenos
        id: check_schedule
        run: |
          HOUR=$(date +%H)
          if [[ "$HOUR" == "10" || "$HOUR" == "22" || "${{ github.event.inputs.force_upcoming }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "ğŸ¬ Ejecutando prÃ³ximos estrenos (hora: $HOUR)"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "â° Omitiendo prÃ³ximos estrenos (hora: $HOUR)"
          fi

  scraping:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Verificar requirements.txt
        run: |
          if [ ! -f requirements.txt ]; then
            echo "âš ï¸ requirements.txt no encontrado, creando uno bÃ¡sico..."
            cat > requirements.txt << EOF
          python-dotenv==1.0.0
          requests==2.31.0
          beautifulsoup4==4.12.2
          flask==3.0.0
          lxml==4.9.3
          EOF
          fi

      - name: ğŸ“š Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Verificar archivos necesarios
        run: |
          echo "ğŸ” Verificando scripts necesarios..."
          for script in scraping_golem.py scraping_yelmo.py scraper_modificado.py integrador.py scrape_ghostintheblog.py proximos_estrenos.py; do
            if [ -f "$script" ]; then
              echo "âœ… $script encontrado"
            else
              echo "âŒ $script NO encontrado"
              exit 1
            fi
          done

      - name: ğŸ›ï¸ Scraping Golem Cines
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          echo "ğŸ¬ Ejecutando scraping de Golem..."
          python scraping_golem.py || echo "âš ï¸ Error en Golem, continuando..."

      - name: ğŸ­ Scraping Yelmo Cines
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          echo "ğŸ¬ Ejecutando scraping de Yelmo..."
          python scraping_yelmo.py || echo "âš ï¸ Error en Yelmo, continuando..."

      - name: ğŸ›ï¸ Scraping Filmoteca + IntegraciÃ³n
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          echo "ğŸ¬ Ejecutando scraping de Filmoteca..."
          # Crear directorios necesarios
          mkdir -p backups imagenes_filmoteca
          
          # Ejecutar scraper con archivo temporal
          python scraper_modificado.py --archivo_salida=peliculas_filmoteca_scraping.json || echo "âš ï¸ Error en scraper, continuando..."
          
          # Ejecutar integrador si existe el archivo temporal
          if [ -f "peliculas_filmoteca_scraping.json" ]; then
            python integrador.py || echo "âš ï¸ Error en integrador, continuando..."
          else
            echo "âš ï¸ No se generÃ³ archivo temporal de Filmoteca"
          fi

      - name: ğŸ‘» Scraping Ghost in the Blog
        run: |
          echo "ğŸ“ Ejecutando scraping de Ghost in the Blog..."
          mkdir -p posts logs
          python scrape_ghostintheblog.py || echo "âš ï¸ Error en Ghost in the Blog, continuando..."

      - name: ğŸ¬ PrÃ³ximos Estrenos TMDb
        if: needs.validate.outputs.should_run_upcoming == 'true'
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          echo "ğŸ¬ Ejecutando script de prÃ³ximos estrenos..."
          mkdir -p imagenes_estrenos
          python proximos_estrenos.py --max-pages=10 --output=proximos_estrenos.json || echo "âš ï¸ Error en prÃ³ximos estrenos, continuando..."

      - name: ğŸ§¹ Limpiar archivos temporales
        run: |
          echo "ğŸ§¹ Limpiando archivos temporales..."
          rm -f peliculas_filmoteca_scraping.json
          
          # Limpiar logs antiguos (mantener solo los Ãºltimos 5)
          if [ -d "logs" ]; then
            cd logs
            ls -t *.log 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
            cd ..
          fi

      - name: ğŸ“Š Generar resumen de archivos
        run: |
          echo "ğŸ“Š Archivos JSON generados:"
          for file in *.json; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              count=$(jq '. | length' "$file" 2>/dev/null || echo "N/A")
              echo "  ğŸ“„ $file - TamaÃ±o: $size - Elementos: $count"
            fi
          done

      - name: ğŸ”„ Verificar cambios
        id: changes
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "No hay cambios para commitear"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Hay cambios para commitear"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Commitear cambios
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "ğŸ¤– Scraping Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Generar mensaje de commit con timestamp
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M UTC')
          COMMIT_MSG="ğŸ”„ ActualizaciÃ³n automÃ¡tica - $TIMESTAMP"
          
          git commit -m "$COMMIT_MSG"
          git pull --rebase origin main
          git push origin main

      - name: ğŸ“„ Preparar archivos para GitHub Pages
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“„ Preparando archivos para GitHub Pages..."
          mkdir -p public
          
          # Copiar solo archivos JSON de datos
          cp *.json public/ 2>/dev/null || true
          
          # Copiar imÃ¡genes (solo las necesarias)
          for dir in imagenes_*/; do
            if [ -d "$dir" ]; then
              cp -r "$dir" public/ 2>/dev/null || true
            fi
          done
          
          # Crear index.html simple para GitHub Pages
          cat > public/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>API de Carteleras de Cine - Navarra</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .endpoint { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
                  code { background: #e0e0e0; padding: 2px 5px; border-radius: 3px; }
              </style>
          </head>
          <body>
              <h1>ğŸ¬ API de Carteleras de Cine - Navarra</h1>
              <p>Datos actualizados automÃ¡ticamente cada 4 horas</p>
              
              <h2>ğŸ“‹ Endpoints disponibles:</h2>
              
              <div class="endpoint">
                  <h3>ğŸ›ï¸ Filmoteca de Navarra</h3>
                  <code>GET /peliculas_filmoteca.json</code>
                  <p>PelÃ­culas de la Filmoteca de Navarra con sesiones VOSE</p>
              </div>
              
              <div class="endpoint">
                  <h3>ğŸ­ Yelmo Cines</h3>
                  <code>GET /peliculas_filmaffinity.json</code>
                  <p>Cartelera de Yelmo Cines en Navarra (solo VOSE)</p>
              </div>
              
              <div class="endpoint">
                  <h3>ğŸ›ï¸ Golem Cines</h3>
                  <code>GET /peliculas_vose.json</code>
                  <p>Cartelera de cines Golem (solo VOSE)</p>
              </div>
              
              <div class="endpoint">
                  <h3>ğŸ¬ PrÃ³ximos Estrenos</h3>
                  <code>GET /proximos_estrenos.json</code>
                  <p>PrÃ³ximos estrenos en EspaÃ±a (actualizado 2 veces al dÃ­a)</p>
              </div>
              
              <div class="endpoint">
                  <h3>ğŸ“ CrÃ­ticas de Cine</h3>
                  <code>GET /index.json</code>
                  <p>Ãndice de crÃ­ticas de pelÃ­culas de Ghost in the Blog</p>
              </div>
              
              <h2>ğŸ”§ Uso</h2>
              <p>Todos los endpoints devuelven datos en formato JSON. Ejemplo:</p>
              <pre>
          fetch('https://tu-usuario.github.io/tu-repo/peliculas_filmoteca.json')
            .then(response => response.json())
            .then(data => console.log(data));
              </pre>
              
              <p><small>Ãšltima actualizaciÃ³n: $(date)</small></p>
          </body>
          </html>
          EOF

      - name: ğŸš€ Deploy a GitHub Pages
        if: steps.changes.outputs.has_changes == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          keep_files: false
          force_orphan: true